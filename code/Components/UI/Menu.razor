@using Sandbox;
@using Sandbox.UI;
@using System.Threading.Tasks;
@using Sandbox.Network;
@using Vidya;
@using System;
@inherits PanelComponent

<root>
    @{
        if ( GameSystem.GameModes is null )
            return;
    }

	<div class="title"> Brick Runner </div>

	<div class="buttons">
		<div class="button" onclick=@( () => Game.ActiveScene.LoadFromFile( "scenes/minimal.scene" ))> Singleplayer </div>
		<div class="button" onclick=@( () => ChangeState( MenuState.Servers ) )> Multiplayer </div>
        <div class="button" onclick=@( () => ChangeState( MenuState.Leaderboards ) )> Leaderboards </div>
		<div class="button" onclick=@( () => Game.Overlay.ShowSettingsModal )> Settings </div>
		<div class="button" onclick=@Game.Close> Exit </div>
	</div>

	@switch (State)
	{
		case MenuState.Servers:
			<div class="servers">

				<div class="server-list">
					@if (Fetching)
					{
						<div class="server"> Fetching servers... </div>
					}
					else if (Lobbies.Count == 0)
					{
						<div class="server"> No servers found. </div>
					}
					else
					{
						@foreach ( var lobby in Lobbies )
						{
							<div class="server" onclick=@( () => JoinLobby( lobby ) )>
								<div class="server-name"> @lobby.Name </div>
								<div class="server-players"> @lobby.Members / @lobby.MaxMembers </div>
							</div>
						}
					}

				</div>

				<div class="server-options">
					<div class="server" onclick=@( () => Game.ActiveScene.LoadFromFile( "scenes/networking_lobby.scene" ) )> Create Lobby </div>
					<div class="server" onclick=@( () => ChangeState( MenuState.None ) )> Exit </div>
				</div>
			</div>

			break;

        case MenuState.Leaderboards:

        <div class="leaderboard">
            <div class="leaderboard-holder">
            @foreach ( var mode in GameSystem.GameModes.Values )
            {
                if ( mode.Hidden )
                    continue;

                var board = Leaderboards[mode.ResourceName];

                if ( board is null )
                    continue;

                @foreach ( var entry in board.Entries )
                {
                    <div class="entry @( entry.SteamId == (long)Sandbox.Utility.Steam.SteamId ? "me" : "")">
                        <div class="name">@entry.Rank: @entry.DisplayName </div>
                        <div class="value"> @entry.Value </div>
                    </div>
                }
            }
            </div>
        </div>
        break;
	}

@code
{
	public enum MenuState
	{
		None,
		Servers,
        Leaderboards
	}

	public MenuState State { get; set; } = MenuState.None;
	
	public List<LobbyInformation> Lobbies { get; set; } = new();

	public bool Fetching { get; set; }
    
    [Property] public Dictionary<string, Sandbox.Services.Leaderboards.Board2> Leaderboards { get; set; } = new();

	protected override void OnStart()
	{
		Scene.TimeScale = 1.0f;
		FetchLobbies();
        FetchLeaderboards();
	}

    public async void FetchLeaderboards()
    {
        if ( GameSystem.GameModes is null )
            return;

        foreach ( var mode in GameSystem.GameModes.Values )
        {
            if ( mode.Hidden )
                continue;

            var board = Sandbox.Services.Leaderboards.GetFromStat( mode.LeaderboardStat );

            board.SetSortDescending();
            board.SetAggregationMax();
		    board.CenterOnMe();
            board.MaxEntries = 50;

            await board.Refresh();

            Leaderboards[mode.ResourceName] = board;
        }
    }

	public async void FetchLobbies()
	{
		while ( true )
		{
			Fetching = true;

			Lobbies = await Networking.QueryLobbies();

			Fetching = false;
			await Task.Delay( 1000 );
		}
	}

	public void JoinLobby( LobbyInformation lobby )
	{
		GameNetworkSystem.Connect( lobby.LobbyId );
	}

	public void ChangeState( MenuState state )
	{
		if ( state == State )
		{
			State = MenuState.None;
			return;
		}
		
		State = state;
	}

	protected override int BuildHash()
	{
		return HashCode.Combine( State, Lobbies?.Count ?? 0, Fetching, Leaderboards.Count() );
	}
}
